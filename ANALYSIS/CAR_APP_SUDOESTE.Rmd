---
title: "APPS SUDOESTE"
author: "NEEDS"
date: "05/2020"
output: 
  html_document:
     
    includes:
      after_body: footer.html
    keep_md: True
    toc: True
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

```{r, echo=FALSE}
inline_hook <- function(x) {
  if (is.numeric(x)) {
    format(x, digits = 2)
  } else x
}
knitr::knit_hooks$set(inline = inline_hook)
```



```{r, "instala os pacotes", echo=FALSE}
list.of.packages <- c("rgdal", "sf", "raster", "rgeos", "fields")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) 

install.packages(new.packages)
```

```{r, "executa os pacotes", message=FALSE, warning=FALSE, echo=FALSE}

require(raster)
require(rgdal)
require(rgeos)
require(sf)
require(fields)

```

```{r}
####Recorta e cria a área que precisa ser recuperada em micro propriedades

calcRestauracao<-function(hidro, propSPDF, tBuff, usoSPDF){
    
  #Faz a intersecção dos objetos, pegando apenas a hidrografia dentro da categoria de propriedade
    app_rest<-intersect(hidro, propSPDF)
    
  #Cria o buffer de acordo com o que é passado pelo tBuff
    app_rest_b<-gBuffer(app_rest, byid=TRUE, width=tBuff)
    
  #Calcula a área do buffer criado e salva em uma nova coluna
  #  app_rest_b$areaHA<-gArea(app_rest_b)/10000
    
  #Agora iremos fazer um intersect entre os buffers e o uso do solo do local, para verificar as areas consolidadas
    usoSPDF<-gBuffer(usoSPDF, byid=TRUE, width=0)
    app_cons<-intersect(usoSPDF, app_rest_b)

    
  
    
    return(app_cons)
}
```

Objetivo: Verificar o quanto deve ser restaurado, segundo o presente na FBDS, das apps presenstes no sudoeste paulista, levando em consideração o tamanho das propriedades  presentes nos municipios.

como: primeiro preciso ter o uso de solo (já recortado pela app (FBDS)?) e a hidrografia separado por tipo de propriedade, será então necessario recortar mais uma vez a hidrografia de acordo com o uso do solo, reitrando as areas que ja possuem vegetação nativa. Com a hidrografia sobresslaente aplicar o buffer com a area que deve ser recuperada em area consolidada.OU...

recortar os dois pelo tipo de propriedade, criar o buffer do que precisaria ser recuperado em area consolidada e depois recortar as areas de vegetação nativa já existentes.

```{r, "carrega os mapas", echo=FALSE, message=FALSE, warning=FALSE, results='hide'}

######carrega os mapas necessários
mapa_CAR<-readOGR(dsn="./DATA_USE/CAR/Barão_de_Antonina",layer="AREA_IMOVEL", use_iconv=TRUE, encoding="UTF-8")
mapa_massa_dagua<-readOGR(dsn="./DATA_USE/FBDS_Hidrografia",layer="SP_3505005_MASSAS_DAGUA", use_iconv=TRUE, encoding="UTF-8")
mapa_nascentes<-readOGR(dsn="./DATA_USE/FBDS_Hidrografia",layer="SP_3505005_NASCENTES", use_iconv=TRUE, encoding="UTF-8")
mapa_rios_simples<-readOGR(dsn="./DATA_USE/FBDS_Hidrografia",layer="SP_3505005_RIOS_SIMPLES", use_iconv=TRUE, encoding="UTF-8")
mapa_rios_duplos<-readOGR(dsn="./DATA_USE/FBDS_Hidrografia",layer="SP_3505005_RIOS_DUPLOS", use_iconv=TRUE, encoding="UTF-8")
mapa_APP_USO_FBDS<-readOGR(dsn="./DATA_USE/FBDS_APP_USO_Municipios",layer="SP_3505005_APP_USO", use_iconv=TRUE, encoding="UTF-8")

```

```{r}
  #reprojetar os obj para a mesma projeção (trocar para a mais adequada)
    mapa_CAR<- spTransform(mapa_CAR, CRS("+init=epsg:31982"))
    mapa_APP_USO_FBDS <- spTransform(mapa_APP_USO_FBDS, CRS("+init=epsg:31982"))
    mapa_rios_duplos <- spTransform(mapa_rios_duplos, CRS("+init=epsg:31982"))
    mapa_rios_simples <- spTransform(mapa_rios_simples, CRS("+init=epsg:31982"))
    mapa_massa_dagua <- spTransform(mapa_massa_dagua, CRS("+init=epsg:31982"))
    mapa_nascentes <- spTransform(mapa_nascentes, CRS("+init=epsg:31982"))
    
    ?gUnaryUnion
```


```{r}

#Separa as propriedades por tamanhos
micro<-mapa_CAR[mapa_CAR@data$NUM_MODULO<1,]
pequena_1_2<-mapa_CAR[mapa_CAR@data$NUM_MODULO>=1 & mapa_CAR@data$NUM_MODULO<2,]
pequena_2_4<-mapa_CAR[mapa_CAR@data$NUM_MODULO>=2 & mapa_CAR@data$NUM_MODULO<4,]
media<-mapa_CAR[mapa_CAR@data$NUM_MODULO>=4 & mapa_CAR@data$NUM_MODULO<10,]
grande<-mapa_CAR[mapa_CAR@data$NUM_MODULO>=10,]

```

```{r}
#Seleciona as massas d'água maiores que 1ha
mapa_massa_dagua<-mapa_massa_dagua[mapa_massa_dagua@data$AREA_HA > 1,]
mapa_massa_dagua<-gBuffer(mapa_massa_dagua, byid=TRUE, width=0)
```


```{r}

micro_app_nas<-calcRestauracao(mapa_nascentes, micro, 15, mapa_APP_USO_FBDS)

micro_app_rms<-calcRestauracao(mapa_rios_simples, micro, 5, mapa_APP_USO_FBDS)

micro_app_rmd<-calcRestauracao(mapa_rios_duplos, micro, 5, mapa_APP_USO_FBDS)

micro_app_mda<-calcRestauracao(mapa_massa_dagua, micro, 5, mapa_APP_USO_FBDS)

```

```{r}
micro_app_nas<-micro_app_nas[micro_app_nas$CLASSE_USO!="formaÃ§Ã£o florestal"]
micro_app_rms<-micro_app_rms[micro_app_rms$CLASSE_USO]

micro_app_all<-gUnion(micro_app_nas, micro_app_rms, byid = TRUE)
plot(micro_app_all)

#somamos as areas de acordo com o uso do solo, as areas sem vegetação nativa será necessaria a restauração (alterar caso necessario)
    sum_app_cons<-rowsum(app_cons$areaHA, group=app_cons$CLASSE_USO)
```


```{r}

pequeno12_app_nas<-calcRestauracao(mapa_nascentes, pequena_1_2, 15, mapa_APP_USO_FBDS)

pequeno12_app_rms<-calcRestauracao(mapa_rios_simples, pequena_1_2, 8, mapa_APP_USO_FBDS)

pequeno12_app_rmd<-calcRestauracao(mapa_rios_duplos, pequena_1_2, 8, mapa_APP_USO_FBDS)

pequeno12_app_mda<-calcRestauracao(mapa_massa_dagua, pequena_1_2, 8, mapa_APP_USO_FBDS)

```

```{r}

pequeno24_app_nas<-calcRestauracao(mapa_nascentes, pequena_2_4, 15, mapa_APP_USO_FBDS)

pequeno24_app_rms<-calcRestauracao(mapa_rios_simples, pequena_2_4, 15, mapa_APP_USO_FBDS)

pequeno24_app_rmd<-calcRestauracao(mapa_rios_duplos, pequena_2_4, 15, mapa_APP_USO_FBDS)

pequeno24_app_mda<-calcRestauracao(mapa_massa_dagua, pequena_2_4, 15, mapa_APP_USO_FBDS)

```

```{r}

media_app_nas<-calcRestauracao(mapa_nascentes, media, 15, mapa_APP_USO_FBDS)

media_app_rms<-calcRestauracao(mapa_rios_simples, media, 20, mapa_APP_USO_FBDS)

media_app_rmd<-calcRestauracao(mapa_rios_duplos, media, 30, mapa_APP_USO_FBDS)

media_app_mda<-calcRestauracao(mapa_massa_dagua, media, 30, mapa_APP_USO_FBDS)

```

```{r}
#areas sem propriedades declaradas
area_sem_car_nas<-gDifference(mapa_nascentes, mapa_CAR)

area_sem_car_rms<-gDifference(mapa_rios_simples, mapa_CAR)

area_sem_car_rmd<-gDifference(mapa_rios_duplos, mapa_CAR)

area_sem_car_mda<-gDifference(mapa_massa_dagua, mapa_CAR)

```
